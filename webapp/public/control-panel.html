<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Research Platform - Control Panel</title>

    <!-- Material-UI CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.2em;
        }

        .status-bar {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            margin: 5px 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background-color: #4caf50;
        }

        .status-inactive {
            background-color: #f44336;
        }

        .status-unknown {
            background-color: #ff9800;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .control-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .control-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
        }

        .control-section h3 .material-icons {
            margin-right: 10px;
            color: #667eea;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .control-button {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            min-height: 48px;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .control-button .material-icons {
            margin-right: 8px;
            font-size: 1.2em;
        }

        .control-button.secondary {
            background: linear-gradient(145deg, #28a745, #20c997);
        }

        .control-button.warning {
            background: linear-gradient(145deg, #ffc107, #fd7e14);
        }

        .control-button.danger {
            background: linear-gradient(145deg, #dc3545, #e83e8c);
        }

        .control-button.info {
            background: linear-gradient(145deg, #17a2b8, #6f42c1);
        }

        .logs-section {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .quick-actions {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
        }

        .quick-actions h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .quick-button {
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.85em;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .quick-button:hover {
            background: #1565c0;
        }

        @media (max-width: 768px) {
            .control-grid {
                grid-template-columns: 1fr;
            }

            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .button-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Research Platform Control Panel</h1>
            <p class="subtitle">Tailscale Network: 100.123.10.72 | Management Dashboard</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator status-active"></div>
                <span>OpenWebUI</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-active"></div>
                <span>Chat Copilot</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-active"></div>
                <span>Perplexica</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-active"></div>
                <span>SearchNG</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-active"></div>
                <span>AutoGen Studio</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-unknown"></div>
                <span>Magentic-One</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-active"></div>
                <span>Windmill</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-active"></div>
                <span>GenAI Stack</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-active"></div>
                <span>Neo4j</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-active"></div>
                <span>ntopng</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-active"></div>
                <span>Provider: OpenAI</span>
            </div>
        </div>

        <div class="control-grid">
            <!-- Service Status Notice -->
            <div class="control-section" style="grid-column: 1 / -1;">
                <div
                    style="background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;">üîç External Services Status</h4>
                    <p style="margin: 0 0 10px 0;"><strong>External services</strong> like Perplexica, SearXNG, and VS
                        Code Web are independent applications that need to be started separately.</p>
                    <p style="margin: 0;"><strong>Available services:</strong> AutoGen Studio, Magentic-One, Chat
                        Copilot, Webhook Server, Port Scanner, Nginx Gateway, GenAI Stack, Neo4j, Windmill</p>
                </div>

                <!-- Nginx Gateway Notice -->
                <div
                    style="background-color: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;">üåê Nginx Gateway Available</h4>
                    <p style="margin: 0 0 10px 0;"><strong>Alternative Access:</strong> Services are also available
                        through the nginx gateway at <strong>port 11999</strong>.</p>
                    <p style="margin: 0 0 10px 0;"><strong>Gateway URL:</strong> <a href="http://100.123.10.72:11999/"
                            target="_blank" style="color: #1976d2;">http://100.123.10.72:11999/</a></p>
                    <p style="margin: 0;"><strong>Example:</strong> Windmill at <a
                            href="http://100.123.10.72:11999/windmill/" target="_blank"
                            style="color: #1976d2;">http://100.123.10.72:11999/windmill/</a></p>
                </div>
            </div>

            <!-- AI Services Section -->
            <div class="control-section">
                <h3><span class="material-icons">smart_toy</span>AI Services</h3>
                <div class="button-grid">
                    <a href="http://100.123.10.72:11880" target="_blank" class="control-button">
                        <span class="material-icons">psychology</span>
                        OpenWebUI
                    </a>
                    <a href="http://100.123.10.72:11000" target="_blank" class="control-button">
                        <span class="material-icons">chat</span>
                        Chat Copilot
                    </a>
                    <a href="http://100.123.10.72:11020" target="_blank" class="control-button" id="perplexica-btn">
                        <span class="material-icons">search</span>
                        Perplexica
                    </a>
                    <a href="http://100.123.10.72:11021" target="_blank" class="control-button" id="searxng-btn">
                        <span class="material-icons">privacy_tip</span>
                        SearXNG
                    </a>
                    <a href="http://100.123.10.72:11001" target="_blank" class="control-button">
                        <span class="material-icons">groups</span>
                        AutoGen Studio
                    </a>
                    <a href="http://100.123.10.72:11003" target="_blank" class="control-button">
                        <span class="material-icons">hub</span>
                        Magentic-One
                    </a>
                    <a href="http://100.123.10.72:8505" target="_blank" class="control-button">
                        <span class="material-icons">account_tree</span>
                        GenAI Stack
                    </a>
                    <a href="http://100.123.10.72:11006" target="_blank" class="control-button">
                        <span class="material-icons">waves</span>
                        Windmill
                    </a>
                </div>
            </div>

            <!-- System Control Section -->
            <div class="control-section">
                <h3><span class="material-icons">settings</span>System Control</h3>
                <div class="button-grid">
                    <button class="control-button secondary" onclick="executeCommand('switch-ai', 'status')">
                        <span class="material-icons">info</span>
                        AI Status
                    </button>
                    <button class="control-button warning" onclick="executeCommand('switch-ai', 'azure')">
                        <span class="material-icons">swap_horiz</span>
                        Switch Azure
                    </button>
                    <button class="control-button warning" onclick="executeCommand('switch-ai', 'openai')">
                        <span class="material-icons">swap_horiz</span>
                        Switch OpenAI
                    </button>
                    <button class="control-button info" onclick="executeCommand('docker', 'ps')">
                        <span class="material-icons">view_list</span>
                        Docker Status
                    </button>
                </div>
            </div>

            <!-- Development Tools Section -->
            <div class="control-section">
                <h3><span class="material-icons">code</span>Development Tools</h3>
                <div class="button-grid">
                    <a href="http://100.123.10.72:57081" target="_blank" class="control-button info" id="vscode-btn">
                        <span class="material-icons">code</span>
                        VS Code Web
                    </a>
                    <a href="http://100.123.10.72:11010" target="_blank" class="control-button info">
                        <span class="material-icons">network_ping</span>
                        Port Scanner
                    </a>
                    <a href="http://100.123.10.72:11000/healthz" target="_blank" class="control-button info">
                        <span class="material-icons">health_and_safety</span>
                        Health Check
                    </a>
                    <a href="http://100.123.10.72:11025" target="_blank" class="control-button info">
                        <span class="material-icons">webhook</span>
                        Webhook Server
                    </a>
                    <button class="control-button secondary" onclick="refreshServices()">
                        <span class="material-icons">refresh</span>
                        Refresh Status
                    </button>
                </div>
            </div>

            <!-- Network Management Section -->
            <div class="control-section">
                <h3><span class="material-icons">router</span>Network Management</h3>
                <div class="button-grid">
                    <a href="http://100.123.10.72:11082" target="_blank" class="control-button">
                        <span class="material-icons">admin_panel_settings</span>
                        Gateway Admin
                    </a>
                    <a href="http://100.123.10.72:8080" target="_blank" class="control-button">
                        <span class="material-icons">dns</span>
                        Nginx Gateway
                    </a>
                    <a href="http://100.123.10.72:8888" target="_blank" class="control-button">
                        <span class="material-icons">network_ping</span>
                        ntopng Monitor
                    </a>
                    <a href="http://100.123.10.72:11434" target="_blank" class="control-button">
                        <span class="material-icons">api</span>
                        Ollama API
                    </a>
                    <a href="http://100.123.10.72:7474" target="_blank" class="control-button">
                        <span class="material-icons">storage</span>
                        Neo4j Database
                    </a>
                    <button class="control-button secondary" onclick="executeCommand('ping', '100.123.10.72')">
                        <span class="material-icons">network_check</span>
                        Test Network
                    </button>
                    <button class="control-button info" onclick="showNetworkInfo()">
                        <span class="material-icons">info</span>
                        Network Info
                    </button>
                </div>
            </div>

            <!-- Service Management Section -->
            <div class="control-section">
                <h3><span class="material-icons">build</span>Service Management</h3>
                <div class="button-grid">
                    <button class="control-button secondary" onclick="executeCommand('docker', 'start-all')">
                        <span class="material-icons">play_arrow</span>
                        Start All
                    </button>
                    <button class="control-button warning" onclick="executeCommand('docker', 'restart')">
                        <span class="material-icons">restart_alt</span>
                        Restart Services
                    </button>
                    <button class="control-button danger" onclick="executeCommand('docker', 'stop-all')">
                        <span class="material-icons">stop</span>
                        Stop All
                    </button>
                    <button class="control-button info" onclick="showLogs()">
                        <span class="material-icons">article</span>
                        View Logs
                    </button>
                </div>
            </div>

            <!-- Application Management Section -->
            <div class="control-section">
                <h3><span class="material-icons">apps</span>Application Management</h3>
                <div class="button-grid">
                    <button class="control-button" onclick="showAddApplicationDialog()">
                        <span class="material-icons">add_circle</span>
                        Add Application
                    </button>
                    <button class="control-button secondary" onclick="listApplications()">
                        <span class="material-icons">list</span>
                        List Applications
                    </button>
                    <button class="control-button info" onclick="testNewApplication()">
                        <span class="material-icons">check_circle</span>
                        Test Application
                    </button>
                    <button class="control-button warning" onclick="removeApplication()">
                        <span class="material-icons">remove_circle</span>
                        Remove Application
                    </button>
                </div>
            </div>

            <!-- Deployment & Automation Section -->
            <div class="control-section">
                <h3><span class="material-icons">rocket_launch</span>Deployment & Automation</h3>
                <div class="button-grid">
                    <button class="control-button secondary" onclick="checkWebhookStatus()">
                        <span class="material-icons">webhook</span>
                        Webhook Status
                    </button>
                    <button class="control-button warning" onclick="manualDeploy()">
                        <span class="material-icons">deploy</span>
                        Manual Deploy
                    </button>
                    <button class="control-button info" onclick="startWebhookServer()">
                        <span class="material-icons">play_arrow</span>
                        Start Webhook
                    </button>
                    <button class="control-button danger" onclick="stopWebhookServer()">
                        <span class="material-icons">stop</span>
                        Stop Webhook
                    </button>
                </div>
            </div>

            <!-- Quick Actions Section -->
            <div class="control-section">
                <h3><span class="material-icons">flash_on</span>Quick Actions</h3>
                <div class="button-grid">
                    <button class="control-button secondary" onclick="testAllServices()">
                        <span class="material-icons">verified</span>
                        Test All
                    </button>
                    <button class="control-button info" onclick="exportConfig()">
                        <span class="material-icons">download</span>
                        Export Config
                    </button>
                    <button class="control-button warning" onclick="backupData()">
                        <span class="material-icons">backup</span>
                        Backup
                    </button>
                    <button class="control-button" onclick="openDashboard()">
                        <span class="material-icons">dashboard</span>
                        Full Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="logs-section" id="logsOutput">
            <div>ü§ñ AI Research Platform Control Panel Ready</div>
            <div>üìä Status: All systems operational</div>
            <div>üîó Tailscale IP: 100.123.10.72</div>
            <div>‚ö° Click any button to execute commands...</div>
        </div>

        <!-- Quick Actions Bar -->
        <div class="quick-actions">
            <h3>üöÄ Frequently Used</h3>
            <div class="quick-buttons">
                <button class="quick-button" onclick="window.open('/', '_blank')">ü§ñ
                    OpenWebUI</button>
                <button class="quick-button" onclick="window.open('/copilot/', '_blank')">üí¨ Chat
                    Copilot</button>
                <button class="quick-button" onclick="window.open('/perplexica', '_blank')">üîç
                    Perplexica</button>
                <button class="quick-button" onclick="executeCommand('switch-ai', 'status')">üìä AI Status</button>
                <button class="quick-button" onclick="refreshServices()">üîÑ Refresh</button>
                <button class="quick-button"
                    onclick="window.open('https://github.com/kmransom56/AI_Research_Platform-_Tailscale', '_blank')">üìö
                    GitHub</button>
                <button class="quick-button" onclick="window.open('/vscode/login', '_blank')">üíª VS
                    Code</button>
            </div>
        </div>
    </div>

    <script>
        /* =============================================
           Dynamic host patch
           ---------------------------------------------
           Anything in this file that still references the
           old hard-coded Tailscale domain will be rewritten
           on the client so the Control-Panel works
           regardless of which hostname it is served from.

           1.  All <a href="‚Ä¶"> links pointing at the old domain
               are rewritten when the DOM is ready.
           2.  All fetch() calls are transparently proxied so
               their URL host is replaced with the current one.
           3.  All window.open() calls are wrapped so external
               links are also rewritten.
        ============================================== */

        (function () {
            const LEGACY_HOST = 'ubuntuaicodeserver-1.tail5137b4.ts.net';
            const CURRENT_BASE = `${window.location.protocol}//${window.location.host}`;

            // --- Fix existing anchor tags -------------------------------------------------
            function rewriteAnchors() {
                document.querySelectorAll(`a[href*="${LEGACY_HOST}"]`).forEach(a => {
                    try {
                        const u = new URL(a.href);
                        // Only rewrite if we're actually on a different host
                        if (u.hostname !== window.location.hostname) {
                            a.href = `${CURRENT_BASE}${u.pathname}${u.search}${u.hash}`;
                        }
                    } catch (_) {
                        /* ignore malformed */
                    }
                });
            }

            // --- Patch global fetch -------------------------------------------------------
            const _fetch = window.fetch.bind(window);
            window.fetch = function (input, init) {
                if (typeof input === 'string' && input.includes(LEGACY_HOST)) {
                    const urlObj = new URL(input);
                    if (urlObj.hostname !== window.location.hostname) {
                        input = `${CURRENT_BASE}${urlObj.pathname}${urlObj.search}${urlObj.hash}`;
                    }
                } else if (input instanceof Request && input.url.includes(LEGACY_HOST)) {
                    const urlObj = new URL(input.url);
                    if (urlObj.hostname !== window.location.hostname) {
                        input = new Request(`${CURRENT_BASE}${urlObj.pathname}${urlObj.search}${urlObj.hash}`, input);
                    }
                }
                return _fetch(input, init);
            };

            // --- Patch window.open --------------------------------------------------------
            const _open = window.open.bind(window);
            window.open = function (url, target, features) {
                if (typeof url === 'string' && url.includes(LEGACY_HOST)) {
                    const urlObj = new URL(url);
                    if (urlObj.hostname !== window.location.hostname) {
                        url = `${CURRENT_BASE}${urlObj.pathname}${urlObj.search}${urlObj.hash}`;
                    }
                }
                return _open(url, target, features);
            };

            // Run once DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', rewriteAnchors);
            } else {
                rewriteAnchors();
            }
        })();

        // Service status tracking
        let serviceStatus = {
            openwebui: 'active',
            chatcopilot: 'active',
            perplexica: 'active',
            searchng: 'active',
            provider: 'openai'
        };

        // Log output function
        function logOutput(message, type = 'info') {
            const logsDiv = document.getElementById('logsOutput');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìù';
            logsDiv.innerHTML += `<div>[${timestamp}] ${icon} ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Execute command function
        async function executeCommand(service, action) {
            logOutput(`Executing ${service} ${action}...`, 'info');

            try {
                switch (service) {
                    case 'switch-ai':
                        await handleAISwitch(action);
                        break;
                    case 'docker':
                        await handleDockerCommand(action);
                        break;
                    case 'ping':
                        await handlePing(action);
                        break;
                    default:
                        logOutput(`Unknown service: ${service}`, 'error');
                }
            } catch (error) {
                logOutput(`Error: ${error.message}`, 'error');
            }
        }

        // Handle AI provider switching
        async function handleAISwitch(action) {
            const messages = {
                'status': 'Checking AI provider status...',
                'azure': 'Switching to Azure OpenAI...',
                'openai': 'Switching to OpenAI...'
            };

            logOutput(messages[action] || 'Unknown AI action', 'info');

            try {
                if (action === 'status') {
                    const response = await fetch('/copilot/api/systemcontrol/status', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        logOutput(`üìä Current Provider: ${data.provider.toUpperCase()}`, 'info');
                        logOutput('üè• Backend: Healthy', 'success');
                        logOutput(`üîó Tailscale IP: ${data.tailscaleIp}`, 'info');

                        // Update service status
                        data.services.forEach(service => {
                            logOutput(`‚úÖ ${service.name}: ${service.status}`, 'success');
                        });

                        serviceStatus.provider = data.provider;
                        updateStatusIndicator();
                    } else {
                        logOutput('‚ùå Failed to get status from backend', 'error');
                    }
                } else {
                    const response = await fetch('/copilot/api/systemcontrol/switch-provider', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ provider: action })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        serviceStatus.provider = action;
                        logOutput(`‚úÖ ${data.message}`, 'success');
                        if (data.output) {
                            logOutput(`üìã Output: ${data.output}`, 'info');
                        }
                        updateStatusIndicator();
                    } else {
                        const error = await response.json();
                        logOutput(`‚ùå Failed to switch provider: ${error.error}`, 'error');
                    }
                }
            } catch (error) {
                logOutput(`‚ùå Network error: ${error.message}`, 'error');
                // Fallback to simulation for demo
                setTimeout(() => {
                    if (action === 'azure') {
                        serviceStatus.provider = 'azure';
                        logOutput('‚úÖ Simulated switch to Azure OpenAI', 'success');
                    } else if (action === 'openai') {
                        serviceStatus.provider = 'openai';
                        logOutput('‚úÖ Simulated switch to OpenAI', 'success');
                    }
                    updateStatusIndicator();
                }, 500);
            }
        }

        // Handle Docker commands
        async function handleDockerCommand(action) {
            const messages = {
                'ps': 'Checking Docker container status...',
                'start-all': 'Starting all Docker services...',
                'restart': 'Restarting Docker services...',
                'stop-all': 'Stopping all Docker services...'
            };

            logOutput(messages[action] || 'Unknown Docker action', 'info');

            try {
                const response = await fetch('/copilot/api/systemcontrol/docker', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action === 'ps' ? 'status' : action })
                });

                if (response.ok) {
                    const data = await response.json();
                    logOutput(`‚úÖ Docker ${data.action} completed successfully`, 'success');
                    if (data.output) {
                        const lines = data.output.split('\n').filter(line => line.trim());
                        lines.forEach(line => {
                            if (line.includes('Up') || line.includes('Exited')) {
                                logOutput(`üê≥ ${line}`, 'info');
                            }
                        });
                    }
                } else {
                    const error = await response.json();
                    logOutput(`‚ùå Docker command failed: ${error.error}`, 'error');
                }
            } catch (error) {
                logOutput(`‚ùå Network error: ${error.message}`, 'error');
                // Fallback to simulation
                setTimeout(() => {
                    if (action === 'ps') {
                        logOutput('üê≥ perplexica-app-1: Up 45 minutes', 'success');
                        logOutput('üê≥ perplexica-searxng-1: Up 45 minutes (healthy)', 'success');
                        logOutput('üê≥ nginx-proxy-manager: Up 45 minutes', 'success');
                        logOutput('üê≥ port-scanner-tailscale: Up 45 minutes', 'success');
                    } else {
                        logOutput(`‚úÖ Simulated Docker ${action} completed`, 'success');
                    }
                }, 1000);
            }
        }

        // Handle network ping
        async function handlePing(target) {
            logOutput(`üèì Pinging ${target}...`, 'info');

            setTimeout(() => {
                logOutput(`‚úÖ ${target} is reachable`, 'success');
                logOutput('üìä Response time: ~5ms', 'info');
                logOutput('üåê Tailscale network: Operational', 'success');
            }, 1000);
        }

        // Test all services
        async function testAllServices() {
            logOutput('üß™ Testing all AI Research Platform services...', 'info');

            try {
                const response = await fetch('/copilot/api/systemcontrol/test-services', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    data.services.forEach(service => {
                        const icon = service.status === 'accessible' ? '‚úÖ' : '‚ùå';
                        const type = service.status === 'accessible' ? 'success' : 'error';
                        logOutput(`${icon} ${service.name}: ${service.status}`, type);
                        if (service.error) {
                            logOutput(`   Error: ${service.error}`, 'error');
                        }
                    });

                    const allHealthy = data.services.every(s => s.status === 'accessible');
                    if (allHealthy) {
                        logOutput('üéâ All services are operational!', 'success');
                    } else {
                        logOutput('‚ö†Ô∏è Some services have issues', 'warning');
                    }
                } else {
                    const error = await response.json();
                    logOutput(`‚ùå Service test failed: ${error.error}`, 'error');
                }
            } catch (error) {
                logOutput(`‚ùå Network error: ${error.message}`, 'error');
                // Fallback to simulation
                const services = [
                    { name: 'OpenWebUI', url: '/openwebui' },
                    { name: 'Chat Copilot', url: '/copilot/' },
                    { name: 'Perplexica', url: '/perplexica' },
                    { name: 'SearchNG', url: '/searxng/' },
                    { name: 'ntopng Network Monitor', url: 'http://100.123.10.72:8888/' },
                    { name: 'Neo4j Database', url: 'http://100.123.10.72:7474/' },
                    { name: 'GenAI Stack Frontend', url: 'http://100.123.10.72:8505/' },
                    { name: 'Windmill', url: 'http://100.123.10.72:11006/' },
                    { name: 'Health Check', url: '/copilot/healthz' }
                ];

                for (let i = 0; i < services.length; i++) {
                    setTimeout(() => {
                        logOutput(`‚úÖ ${services[i].name}: Simulated test passed`, 'success');
                        if (i === services.length - 1) {
                            logOutput('üéâ All simulated tests completed!', 'success');
                        }
                    }, (i + 1) * 300);
                }
            }
        }

        // Refresh service status
        function refreshServices() {
            logOutput('üîÑ Refreshing service status...', 'info');

            setTimeout(() => {
                logOutput('‚úÖ Status refresh completed', 'success');
                logOutput('üìä All services: Operational', 'success');
                updateStatusIndicator();
            }, 1000);
        }

        // Update status indicators
        function updateStatusIndicator() {
            // Update provider status in the status bar
            const statusItems = document.querySelectorAll('.status-item');
            statusItems.forEach(item => {
                if (item.textContent.includes('Provider:')) {
                    item.innerHTML = `
                        <div class="status-indicator status-active"></div>
                        <span>Provider: ${serviceStatus.provider.toUpperCase()}</span>
                    `;
                }
            });
        }

        // Show network information
        function showNetworkInfo() {
            logOutput('üåê Network Information:', 'info');
            logOutput('üìç Tailscale IP: 100.123.10.72', 'info');
            logOutput('üîó Network Type: Tailscale VPN', 'info');
            logOutput('üåç Access: Global (via Tailscale)', 'info');
            logOutput('üîí Security: Encrypted mesh network', 'info');
        }

        // Show logs
        function showLogs() {
            logOutput('üìã Recent system activity:', 'info');
            logOutput('üïê 2025-06-14 09:45:12 - Chat Copilot: Backend healthy', 'info');
            logOutput('üïê 2025-06-14 09:44:58 - Perplexica: AI search ready', 'info');
            logOutput('üïê 2025-06-14 09:44:45 - OpenWebUI: Connected', 'info');
        }

        // Export configuration
        function exportConfig() {
            logOutput('üì¶ Exporting configuration...', 'info');

            const config = {
                tailscale_ip: '100.123.10.72',
                services: serviceStatus,
                timestamp: new Date().toISOString(),
                endpoints: {
                    openwebui: '/openwebui',
                    chatcopilot: '/copilot/',
                    perplexica: '/perplexica',
                    searchng: '/searxng/'
                }
            };

            setTimeout(() => {
                logOutput('‚úÖ Configuration exported successfully', 'success');
                logOutput('üíæ File: ai-platform-config.json', 'info');
            }, 800);
        }

        // Backup data
        function backupData() {
            logOutput('üíæ Creating system backup...', 'info');

            setTimeout(() => {
                logOutput('‚úÖ Backup completed successfully', 'success');
                logOutput('üìÅ Location: /home/keith/backups/', 'info');
                logOutput('üóìÔ∏è Timestamp: ' + new Date().toLocaleString(), 'info');
            }, 1200);
        }

        // Check external services status
        async function checkExternalServices() {
            const services = [
                { id: 'perplexica-btn', url: '/perplexica', name: 'Perplexica' },
                { id: 'searxng-btn', url: '/searxng/', name: 'SearXNG' },
                { id: 'vscode-btn', url: '/vscode/login', name: 'VS Code Web' },
                { id: 'windmill-btn', url: 'http://100.123.10.72:11006/', name: 'Windmill' }
            ];

            for (const service of services) {
                try {
                    const response = await fetch(service.url, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        timeout: 3000
                    });
                    // If we get here without error, service is likely up
                    document.getElementById(service.id).style.opacity = '1.0';
                    document.getElementById(service.id).title = `${service.name} - Available`;
                } catch (error) {
                    // Service is likely down
                    document.getElementById(service.id).style.opacity = '0.5';
                    document.getElementById(service.id).title = `${service.name} - Not Available (External Service)`;
                    const icon = document.getElementById(service.id).querySelector('.material-icons');
                    if (icon) {
                        icon.style.color = '#ccc';
                    }
                }
            }
        }

        // Run status check on page load
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(checkExternalServices, 1000);
        });

        // Open full dashboard
        function openDashboard() {
            window.open('/applications.html', '_blank');
            logOutput('üöÄ Opening full applications dashboard...', 'info');
        }

        // Webhook management functions
        async function checkWebhookStatus() {
            logOutput('üîç Checking webhook server status...', 'info');

            try {
                const response = await fetch('/webhook/health', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    logOutput('‚úÖ Webhook server is running', 'success');
                    logOutput(`üìä Uptime: ${Math.floor(data.uptime / 60)} minutes`, 'info');
                    logOutput(`üïê Status check: ${data.timestamp}`, 'info');

                    // Get detailed status
                    const statusResponse = await fetch('/webhook/status');
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        logOutput(`üìã Recent webhook activity:`, 'info');
                        statusData.recentLogs.slice(-3).forEach(log => {
                            logOutput(`   ${log}`, 'info');
                        });
                    }
                } else {
                    logOutput('‚ùå Webhook server not responding', 'error');
                }
            } catch (error) {
                logOutput('‚ùå Webhook server is not running', 'error');
                logOutput('üí° Use "Start Webhook" button to launch it', 'info');
            }
        }

        async function manualDeploy() {
            logOutput('üöÄ Triggering manual deployment...', 'info');

            try {
                const response = await fetch('/webhook/deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    logOutput('‚úÖ Manual deployment started successfully', 'success');
                    logOutput('üìã Check deployment logs for progress', 'info');

                    // Monitor deployment progress
                    setTimeout(checkDeploymentStatus, 5000);
                } else {
                    const error = await response.json();
                    logOutput(`‚ùå Deployment failed: ${error.error}`, 'error');
                }
            } catch (error) {
                logOutput('‚ùå Could not connect to webhook server', 'error');
                logOutput('üí° Ensure webhook server is running first', 'info');
            }
        }

        async function startWebhookServer() {
            logOutput('üöÄ Starting webhook server...', 'info');

            try {
                // First check if it's already running
                const healthCheck = await fetch('/webhook/health').catch(() => null);
                if (healthCheck && healthCheck.ok) {
                    logOutput('‚ö†Ô∏è Webhook server is already running', 'warning');
                    return;
                }

                // Start the webhook server
                const response = await fetch('/copilot/api/systemcontrol/docker', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'start-webhook',
                        command: 'cd /home/keith/chat-copilot && nohup node webhook-server.js > webhook.log 2>&1 &'
                    })
                });

                if (response.ok) {
                    logOutput('‚úÖ Webhook server start command sent', 'success');
                    logOutput('üîÑ Checking server status in 3 seconds...', 'info');
                    setTimeout(checkWebhookStatus, 3000);
                } else {
                    logOutput('‚ùå Failed to start webhook server', 'error');
                }
            } catch (error) {
                logOutput('‚ùå Error starting webhook server', 'error');
                logOutput('üí° Try running manually: node webhook-server.js', 'info');
            }
        }

        async function stopWebhookServer() {
            logOutput('üõë Stopping webhook server...', 'info');

            try {
                const response = await fetch('/copilot/api/systemcontrol/docker', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'stop-webhook',
                        command: 'pkill -f "node.*webhook-server.js"'
                    })
                });

                if (response.ok) {
                    logOutput('‚úÖ Webhook server stop command sent', 'success');
                    logOutput('üîÑ Verifying shutdown...', 'info');
                    setTimeout(() => {
                        fetch('/webhook/health')
                            .then(() => logOutput('‚ö†Ô∏è Server may still be running', 'warning'))
                            .catch(() => logOutput('‚úÖ Webhook server stopped successfully', 'success'));
                    }, 2000);
                } else {
                    logOutput('‚ùå Failed to stop webhook server', 'error');
                }
            } catch (error) {
                logOutput('‚ùå Error stopping webhook server', 'error');
            }
        }

        async function checkDeploymentStatus() {
            try {
                const response = await fetch('/webhook/status');
                if (response.ok) {
                    const data = await response.json();
                    const recentLogs = data.recentLogs.slice(-2);
                    recentLogs.forEach(log => {
                        if (log.includes('Deployment completed') || log.includes('‚úÖ') || log.includes('‚ùå')) {
                            logOutput(`üìã ${log}`, log.includes('‚ùå') ? 'error' : 'success');
                        }
                    });
                }
            } catch (error) {
                logOutput('‚ö†Ô∏è Could not check deployment status', 'warning');
            }
        }

        // Application Management Functions
        function showAddApplicationDialog() {
            logOutput('üì± Opening Add Application dialog...', 'info');

            const name = prompt('Application Name (e.g., "Grafana"):');
            if (!name) return;

            const port = prompt('Application Port (11000-12000 range):');
            if (!port || isNaN(port) || port < 11000 || port > 12000) {
                logOutput('‚ùå Invalid port. Must be between 11000-12000', 'error');
                return;
            }

            const path = prompt('URL Path (e.g., "/grafana"):');
            if (!path || !path.startsWith('/')) {
                logOutput('‚ùå Invalid path. Must start with /', 'error');
                return;
            }

            const description = prompt('Description:');
            if (!description) return;

            const category = prompt('Category (ai/dev/network/api):') || 'ai';
            const dockerImage = prompt('Docker Image (optional):') || '';

            // Show the command that would be executed
            let command = `./scripts/platform-management/add-application.sh --name "${name}" --port ${port} --path "${path}" --description "${description}" --category ${category}`;
            if (dockerImage) {
                command += ` --docker-image "${dockerImage}"`;
            }

            logOutput('üöÄ Generated command:', 'info');
            logOutput(command, 'info');
            logOutput('üìã Copy this command and run it in terminal', 'info');
            logOutput('‚ö†Ô∏è  Remember to reload nginx after adding', 'warning');

            // Copy to clipboard if supported
            if (navigator.clipboard) {
                navigator.clipboard.writeText(command).then(() => {
                    logOutput('üìã Command copied to clipboard!', 'success');
                });
            }
        }

        function listApplications() {
            logOutput('üìã Listing current applications...', 'info');

            const applications = [
                'OpenWebUI (11880)',
                'Chat Copilot (11000)',
                'Perplexica (11020)',
                'SearXNG (11021)',
                'AutoGen Studio (11001)',
                'Magentic-One (11003)',
                'Windmill (11006)',
                'Webhook Server (11002)',
                'Port Scanner (11010)',
                'VS Code Web (57081)',
                'Neo4j GenAI Stack (8501-8505)',
                'Nginx Gateway (11080-11082)',
                'ntopng Network Monitor (8888)',
                'Ollama LLM (11434)'
            ];

            logOutput('üì± Currently configured applications:', 'info');
            applications.forEach(app => {
                logOutput(`   ‚Ä¢ ${app}`, 'info');
            });

            logOutput('üîó Full list: https://ubuntuaicodeserver-1.tail5137b4.ts.net:10443/applications.html', 'info');
        }

        function testNewApplication() {
            const path = prompt('Enter application path to test (e.g., "/windmill"):');
            if (!path) return;

            logOutput(`üîç Testing application at ${path}...`, 'info');

            const testUrl = `https://ubuntuaicodeserver-1.tail5137b4.ts.net:10443${path}`;

            fetch(testUrl, { method: 'HEAD', mode: 'no-cors' })
                .then(() => {
                    logOutput(`‚úÖ Application ${path} appears to be accessible`, 'success');
                    logOutput(`üîó URL: ${testUrl}`, 'info');

                    if (confirm(`Open ${path} in new tab?`)) {
                        window.open(testUrl, '_blank');
                    }
                })
                .catch(() => {
                    logOutput(`‚ùå Application ${path} is not accessible`, 'error');
                    logOutput('üí° Check if the service is running and nginx is configured', 'warning');
                });
        }

        function removeApplication() {
            logOutput('üóëÔ∏è  Application removal process...', 'warning');

            const appName = prompt('Enter application name to remove:');
            if (!appName) return;

            const confirmRemoval = confirm(`Are you sure you want to remove "${appName}"? This will:\n- Remove nginx configuration\n- Stop Docker container\n- Remove from applications page\n\nThis action cannot be undone.`);

            if (confirmRemoval) {
                logOutput(`‚ö†Ô∏è  Manual removal required for ${appName}:`, 'warning');
                logOutput('1. Edit /etc/nginx/sites-available/ai-hub.conf (remove location block)', 'info');
                logOutput('2. Run: sudo systemctl reload nginx', 'info');
                logOutput('3. Stop Docker container: docker stop <container-name>', 'info');
                logOutput('4. Remove from docker-compose.yml', 'info');
                logOutput('5. Remove from applications.html', 'info');
                logOutput('6. Update port documentation', 'info');
                logOutput('üîÑ Consider creating an automated removal script', 'info');
            }
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function () {
            logOutput('üéØ AI Research Platform Control Panel Initialized', 'success');
            logOutput('üîß All functions ready for use', 'info');
            updateStatusIndicator();
        });
    </script>
</body>

</html>