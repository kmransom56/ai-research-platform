{
	admin 0.0.0.0:2019
}

# HTTPS with Tailscale domain - SSL termination on port 10443
ubuntuaicodeserver-1.tail5137b4.ts.net:10443 {
	tls /etc/ssl/certs/ubuntuaicodeserver.tail5137b4.ts.net.crt /etc/ssl/private/ubuntuaicodeserver.tail5137b4.ts.net.key

	# Serve static files from /srv (mounted from webapp/public) FIRST
	@staticFiles {
		path_regexp staticFiles ^/[^/]+\.html$
	}
	root @staticFiles /srv
	file_server @staticFiles

	############################################################
	# Path-based services (handle_path overrides default) #
	############################################################
	handle_path /vscode* {
		reverse_proxy 100.123.10.72:57081
	}
	handle_path /copilot/api* {
		reverse_proxy 100.123.10.72:3080
	}
	handle_path /copilot* {
		reverse_proxy 100.123.10.72:3000
	}
	handle_path /autogen* {
		reverse_proxy 100.123.10.72:11001
	}
	handle_path /magentic* {
		reverse_proxy magentic-one:11003
	}
	handle_path /webhook* {
		reverse_proxy 100.123.10.72:11002
	}
	handle_path /portscanner* {
		reverse_proxy 100.123.10.72:11010
	}
	handle_path /nginx* {
		reverse_proxy 100.123.10.72:11080
	}
	handle_path /gateway-http* {
		reverse_proxy 100.123.10.72:11081
	}
	handle_path /gateway-https* {
		reverse_proxy 100.123.10.72:11082
	}
	handle_path /fortinet* {
		reverse_proxy 100.123.10.72:3001
	}
	handle /perplexica* {
		reverse_proxy 100.123.10.72:11020
	}
	handle_path /searxng* {
		reverse_proxy 100.123.10.72:11021
	}
	handle_path /ollama* {
		reverse_proxy 100.123.10.72:11434
	}
	handle /openwebui* {
		rewrite * /
		reverse_proxy openwebui:8080
	}

	############################################################
	# Control Panel served at /hub/ #
	############################################################
	handle_path /hub* {
		rewrite * /control-panel.html
		reverse_proxy 100.123.10.72:3000
	}

	############################################################
	# Default (root) â†’ OpenWebUI #
	############################################################
	@htmlFiles {
		path_regexp htmlFiles ^/[^/]+\.html$
	}
	root @htmlFiles /srv
	file_server @htmlFiles

	handle /* {
		reverse_proxy openwebui:8080
	}

	############################################################
	# Security headers + gzip + logging #
	############################################################
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
	}

	encode gzip

	log {
		output file /var/log/caddy/access.log
	}
}