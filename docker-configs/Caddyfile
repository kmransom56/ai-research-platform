{
	admin 0.0.0.0:2019
}

# HTTP to HTTPS redirect
ubuntuaicodeserver-1.tail5137b4.ts.net:80, 100.123.10.72:80 {
	redir https://{host}:8443{uri} permanent
}

# HTTPS with CA-issued certificates
ubuntuaicodeserver-1.tail5137b4.ts.net:8443, 100.123.10.72:8443 {
	tls /etc/ssl/certs/ubuntuaicodeserver.tail5137b4.ts.net.crt /etc/ssl/private/ubuntuaicodeserver.tail5137b4.ts.net.key

	# Serve static files from /srv (mounted from webapp/public) FIRST
	@staticFiles {
		path_regexp staticFiles ^/[^/]+\.html$
	}
	root @staticFiles /srv
	file_server @staticFiles

	############################################################
	# Path-based services (handle_path overrides default) #
	############################################################
	handle_path /vscode* {
		reverse_proxy 100.123.10.72:57081
	}
	handle_path /copilot/api* {
		reverse_proxy 100.123.10.72:11000
	}
	handle_path /copilot* {
		reverse_proxy 100.123.10.72:3000
	}
	handle_path /autogen* {
		reverse_proxy 100.123.10.72:11001
	}
	handle_path /magentic* {
		reverse_proxy 100.123.10.72:11003
	}
	handle_path /webhook* {
		reverse_proxy 100.123.10.72:11002
	}
	handle_path /portscanner* {
		reverse_proxy 100.123.10.72:11010
	}
	handle_path /nginx* {
		reverse_proxy 100.123.10.72:11080
	}
	handle_path /gateway-http* {
		reverse_proxy 100.123.10.72:11081
	}
	handle_path /gateway-https* {
		reverse_proxy 100.123.10.72:11082
	}
	handle_path /fortinet-api* {
		reverse_proxy 100.123.10.72:5000
	}
	handle_path /fortinet* {
		reverse_proxy 100.123.10.72:3001
	}
	handle /perplexica* {
		reverse_proxy 100.123.10.72:11020
	}
	
	# SearXNG with proper static asset handling
	handle /searxng/static/* {
		uri strip_prefix /searxng
		reverse_proxy 100.123.10.72:11021
	}
	
	handle /searxng* {
		reverse_proxy 100.123.10.72:11021
	}
	handle_path /ollama* {
		reverse_proxy 100.123.10.72:11434
	}
	# OpenWebUI and its static assets
	handle_path /openwebui* {
		reverse_proxy 100.123.10.72:11880
	}
	
	# Service-specific static assets
	handle /copilot/static/* {
		reverse_proxy 100.123.10.72:3000
	}
	
	handle /portscanner/static/* {
		reverse_proxy 100.123.10.72:11010
	}
	
	
	# SearXNG static assets (specific paths first)
	handle /static/themes/* {
		reverse_proxy 100.123.10.72:11021
	}
	
	# OpenWebUI static assets (catch remaining /static/* paths)
	handle /static/* {
		reverse_proxy 100.123.10.72:11880
	}
	
	handle /_app/* {
		reverse_proxy 100.123.10.72:11880
	}

	############################################################
	# Control Panel served at /hub/ #
	############################################################
	handle_path /hub* {
		rewrite * /control-panel.html
		file_server {
			root /srv
		}
	}

	############################################################
	# Static HTML files (applications.html, control-panel.html, etc.) #
	############################################################
	@htmlFiles {
		path_regexp htmlFiles ^/[^/]+\.html$
	}
	root @htmlFiles /srv
	file_server @htmlFiles

	############################################################
	# Default (root) → Control Panel #
	############################################################
	handle / {
		rewrite * /control-panel.html
		file_server {
			root /srv
		}
	}

	############################################################
	# Catch-all for unmatched routes → 404 or static files #
	############################################################
	handle {
		file_server {
			root /srv
		}
	}

	############################################################
	# Security headers + gzip + logging #
	############################################################
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
	}

	encode gzip

	log {
		output file /var/log/caddy/access.log
	}
}