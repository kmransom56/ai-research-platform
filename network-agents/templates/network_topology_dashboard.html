<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è Network Topology Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .dashboard-header {
            background: rgba(0,0,0,0.2);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .control-group select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .control-group select option {
            background: #2c3e50;
            color: white;
        }
        
        .dashboard-content {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 300px;
            background: rgba(0,0,0,0.15);
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .main-view {
            flex: 1;
            position: relative;
            background: rgba(0,0,0,0.05);
        }
        
        .stats-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .stats-panel h3 {
            margin-bottom: 15px;
            color: #ecf0f1;
            font-size: 1.1rem;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .stat-value {
            font-weight: bold;
        }
        
        .health-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .health-healthy { background-color: #2ecc71; }
        .health-warning { background-color: #f39c12; }
        .health-critical { background-color: #e74c3c; }
        
        .legend {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .legend h3 {
            margin-bottom: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        .network-visualization {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .node {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
        }
        
        .node:hover {
            stroke-width: 3px;
            opacity: 0.8;
        }
        
        .link {
            stroke: rgba(255,255,255,0.6);
            stroke-width: 1px;
        }
        
        .node-label {
            font-size: 10px;
            fill: white;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: rgba(231,76,60,0.2);
            border: 1px solid #e74c3c;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin: 20px;
        }
        
        .filter-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .filter-panel h3 {
            margin-bottom: 15px;
        }
        
        .filter-checkbox {
            margin-bottom: 10px;
        }
        
        .filter-checkbox input {
            margin-right: 8px;
        }
        
        .filter-checkbox label {
            font-size: 0.9rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-title">üó∫Ô∏è Network Topology Dashboard</div>
        <div class="header-controls">
            <div class="control-group">
                <label>Organization</label>
                <select id="organizationFilter">
                    <option value="">All Organizations</option>
                </select>
            </div>
            <div class="control-group">
                <label>View Mode</label>
                <select id="viewMode">
                    <option value="full">Full Topology</option>
                    <option value="infrastructure">Infrastructure Only</option>
                    <option value="endpoints">Endpoints Only</option>
                </select>
            </div>
            <button onclick="refreshData()" style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                üîÑ Refresh
            </button>
        </div>
    </div>
    
    <div class="dashboard-content">
        <div class="sidebar">
            <div class="stats-panel" id="statsPanel">
                <h3>üìä Network Overview</h3>
                <div id="networkStats">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading network data...
                    </div>
                </div>
            </div>
            
            <div class="stats-panel" id="endpointPanel">
                <h3>üç¥ Restaurant Equipment</h3>
                <div id="endpointStats">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading endpoint data...
                    </div>
                </div>
            </div>
            
            <div class="legend">
                <h3>üé® Legend</h3>
                
                <h4 style="margin: 15px 0 10px 0; font-size: 0.95rem;">Infrastructure Devices:</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d62728;"></div>
                    Security Appliances (MX)
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2ca02c;"></div>
                    Switches (MS)
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9467bd;"></div>
                    Wireless APs (MR)
                </div>
                
                <h4 style="margin: 15px 0 10px 0; font-size: 0.95rem;">Restaurant Equipment:</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b35;"></div>
                    POS Systems
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2ecc71;"></div>
                    Kitchen Displays
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    Self-Service Kiosks
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    Drive-Thru Equipment
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9b59b6;"></div>
                    Digital Menu Boards
                </div>
                
                <h4 style="margin: 15px 0 10px 0; font-size: 0.95rem;">Health Status:</h4>
                <div class="legend-item">
                    <div class="health-indicator health-healthy"></div>
                    Healthy (95%+)
                </div>
                <div class="legend-item">
                    <div class="health-indicator health-warning"></div>
                    Warning (80-94%)
                </div>
                <div class="legend-item">
                    <div class="health-indicator health-critical"></div>
                    Critical (<80%)
                </div>
            </div>
            
            <div class="filter-panel">
                <h3>üîç Filters</h3>
                <div class="filter-checkbox">
                    <input type="checkbox" id="showInfrastructure" checked>
                    <label for="showInfrastructure">Infrastructure Devices</label>
                </div>
                <div class="filter-checkbox">
                    <input type="checkbox" id="showEndpoints" checked>
                    <label for="showEndpoints">Endpoint Devices</label>
                </div>
                <div class="filter-checkbox">
                    <input type="checkbox" id="showHealthy" checked>
                    <label for="showHealthy">Healthy Devices</label>
                </div>
                <div class="filter-checkbox">
                    <input type="checkbox" id="showWarning" checked>
                    <label for="showWarning">Warning Devices</label>
                </div>
                <div class="filter-checkbox">
                    <input type="checkbox" id="showCritical" checked>
                    <label for="showCritical">Critical Devices</label>
                </div>
            </div>
        </div>
        
        <div class="main-view">
            <div class="loading" id="mainLoading">
                <div class="loading-spinner"></div>
                Loading network topology...
            </div>
            <div class="network-visualization" id="networkVisualization"></div>
            <div class="tooltip" id="tooltip"></div>
        </div>
    </div>

    <script>
        class NetworkTopologyDashboard {
            constructor() {
                this.networkData = null;
                this.currentOrganization = null;
                this.svg = null;
                this.simulation = null;
                
                this.initializeEventListeners();
                this.loadInitialData();
            }
            
            initializeEventListeners() {
                document.getElementById('organizationFilter').addEventListener('change', (e) => {
                    this.currentOrganization = e.target.value || null;
                    this.loadNetworkMap();
                });
                
                document.getElementById('viewMode').addEventListener('change', () => {
                    this.updateVisualization();
                });
                
                // Filter checkboxes
                const filterCheckboxes = document.querySelectorAll('.filter-checkbox input');
                filterCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => this.updateVisualization());
                });
            }
            
            async loadInitialData() {
                try {
                    // Load organizations for dropdown
                    const orgResponse = await fetch('/api/organizations');
                    const orgData = await orgResponse.json();
                    
                    if (orgData.success) {
                        this.populateOrganizationDropdown(orgData.data);
                    }
                    
                    // Load initial network data
                    await this.loadNetworkStats();
                    await this.loadNetworkMap();
                    
                } catch (error) {
                    console.error('Error loading initial data:', error);
                    this.showError('Failed to load initial dashboard data');
                }
            }
            
            populateOrganizationDropdown(organizations) {
                const select = document.getElementById('organizationFilter');
                
                organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.name;
                    option.textContent = org.name;
                    select.appendChild(option);
                });
            }
            
            async loadNetworkStats() {
                try {
                    const response = await fetch('/api/health-summary');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateStatsPanel(data.data);
                    }
                } catch (error) {
                    console.error('Error loading network stats:', error);
                }
            }
            
            updateStatsPanel(data) {
                const statsDiv = document.getElementById('networkStats');
                const endpointDiv = document.getElementById('endpointStats');
                
                // Infrastructure stats
                if (data.infrastructure_health) {
                    const health = data.infrastructure_health;
                    statsDiv.innerHTML = `
                        <div class="stat-row">
                            <span>Total Devices:</span>
                            <span class="stat-value">${(health.healthy || 0) + (health.warning || 0) + (health.critical || 0)}</span>
                        </div>
                        <div class="stat-row">
                            <span><span class="health-indicator health-healthy"></span>Healthy:</span>
                            <span class="stat-value">${health.healthy || 0}</span>
                        </div>
                        <div class="stat-row">
                            <span><span class="health-indicator health-warning"></span>Warning:</span>
                            <span class="stat-value">${health.warning || 0}</span>
                        </div>
                        <div class="stat-row">
                            <span><span class="health-indicator health-critical"></span>Critical:</span>
                            <span class="stat-value">${health.critical || 0}</span>
                        </div>
                        <div class="stat-row">
                            <span>Avg Health:</span>
                            <span class="stat-value">${health.avg_health ? health.avg_health.toFixed(1) + '%' : 'N/A'}</span>
                        </div>
                    `;
                }
                
                // Endpoint stats
                if (data.endpoint_breakdown) {
                    let endpointHtml = '';
                    data.endpoint_breakdown.forEach(item => {
                        const displayName = item.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        endpointHtml += `
                            <div class="stat-row">
                                <span>${displayName}:</span>
                                <span class="stat-value">${item.count}</span>
                            </div>
                        `;
                    });
                    endpointDiv.innerHTML = endpointHtml || '<div class="stat-row">No endpoint data available</div>';
                }
            }
            
            async loadNetworkMap() {
                try {
                    document.getElementById('mainLoading').style.display = 'block';
                    
                    const url = this.currentOrganization ? 
                        `/api/network-map?organization_id=${encodeURIComponent(this.currentOrganization)}` : 
                        '/api/network-map';
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.networkData = data.data;
                        this.createVisualization();
                    } else {
                        this.showError(data.error);
                    }
                } catch (error) {
                    console.error('Error loading network map:', error);
                    this.showError('Failed to load network map data');
                } finally {
                    document.getElementById('mainLoading').style.display = 'none';
                }
            }
            
            createVisualization() {
                if (!this.networkData) return;
                
                const container = document.getElementById('networkVisualization');
                container.innerHTML = '';
                
                const width = container.clientWidth || 1200;
                const height = container.clientHeight || 800;
                
                // Check for large dataset and warn user
                const nodeCount = this.networkData.nodes ? this.networkData.nodes.length : 0;
                if (nodeCount > 5000) {
                    container.innerHTML = `
                        <div class="error-message">
                            <strong>Large Dataset Warning</strong><br>
                            This visualization contains ${nodeCount} nodes which may cause performance issues.<br><br>
                            
                            <strong>Recommendations:</strong><br>
                            ‚Ä¢ Select a specific organization from the dropdown above<br>
                            ‚Ä¢ Use the view mode filter to show only infrastructure or endpoints<br>
                            ‚Ä¢ Filter by device health status<br><br>
                            
                            <button onclick="window.dashboard.createVisualizationForced()" style="background: #3498db; color: white; border: none; padding: 5px 10px; margin-top: 10px; border-radius: 3px; cursor: pointer;">
                                Load Full Visualization (May Be Slow)
                            </button>
                            
                            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 0.9rem;">
                                <strong>Dataset Summary:</strong><br>
                                Organizations: ${this.networkData.stats?.total_organizations || 'N/A'}<br>
                                Networks: ${this.networkData.stats?.total_networks || 'N/A'}<br>  
                                Infrastructure Devices: ${this.networkData.stats?.total_infrastructure_devices || 'N/A'}<br>
                                Endpoint Devices: ${this.networkData.stats?.total_endpoint_devices || 'N/A'}
                            </div>
                        </div>
                    `;
                    return;
                }
                
                this.createVisualizationInternal();
            }
            
            createDragBehavior() {
                return d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) this.simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        if (!event.active) this.simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    });
            }
            
            showTooltip(event, d) {
                const tooltip = document.getElementById('tooltip');
                
                let content = `
                    <strong>${d.label}</strong><br>
                    Type: ${d.type.replace(/_/g, ' ')}<br>
                `;
                
                if (d.health_score !== undefined) {
                    content += `Health: ${d.health_score.toFixed(1)}%<br>`;
                }
                
                if (d.endpoint_count !== undefined) {
                    content += `Endpoints: ${d.endpoint_count}<br>`;
                }
                
                if (d.restaurant_function) {
                    content += `Function: ${d.restaurant_function}<br>`;
                }
                
                if (d.operational_priority) {
                    content += `Priority: ${d.operational_priority}<br>`;
                }
                
                tooltip.innerHTML = content;
                tooltip.style.left = (event.pageX + 10) + 'px';
                tooltip.style.top = (event.pageY + 10) + 'px';
                tooltip.style.opacity = 1;
            }
            
            hideTooltip() {
                const tooltip = document.getElementById('tooltip');
                tooltip.style.opacity = 0;
            }
            
            updateVisualization() {
                if (!this.svg) return;
                
                const viewMode = document.getElementById('viewMode').value;
                const showInfrastructure = document.getElementById('showInfrastructure').checked;
                const showEndpoints = document.getElementById('showEndpoints').checked;
                const showHealthy = document.getElementById('showHealthy').checked;
                const showWarning = document.getElementById('showWarning').checked;
                const showCritical = document.getElementById('showCritical').checked;
                
                // Update node visibility
                this.svg.selectAll('.node')
                    .style('display', d => {
                        // View mode filter
                        if (viewMode === 'infrastructure' && d.type === 'endpoint_device') return 'none';
                        if (viewMode === 'endpoints' && d.type !== 'endpoint_device') return 'none';
                        
                        // Type filter
                        if (d.type === 'infrastructure_device' && !showInfrastructure) return 'none';
                        if (d.type === 'endpoint_device' && !showEndpoints) return 'none';
                        
                        // Health filter
                        if (d.health_status === 'healthy' && !showHealthy) return 'none';
                        if (d.health_status === 'warning' && !showWarning) return 'none';
                        if (d.health_status === 'critical' && !showCritical) return 'none';
                        
                        return 'block';
                    });
                
                // Update label visibility
                this.svg.selectAll('.node-label')
                    .style('display', d => {
                        const nodeVisible = this.svg.select(`circle[data-id="${d.id}"]`).style('display');
                        return nodeVisible === 'none' ? 'none' : 'block';
                    });
            }
            
            createVisualizationForced() {
                // Force visualization creation even with large datasets
                if (!this.networkData) return;
                
                const container = document.getElementById('networkVisualization');
                container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading large visualization...</div>';
                
                // Use setTimeout to allow UI update before heavy computation
                setTimeout(() => {
                    try {
                        this.createVisualizationInternal();
                    } catch (error) {
                        console.error('Error creating visualization:', error);
                        this.showError('Failed to create visualization: ' + error.message);
                    }
                }, 100);
            }
            
            createVisualizationInternal() {
                const container = document.getElementById('networkVisualization');
                container.innerHTML = '';
                
                const width = container.clientWidth || 1200;
                const height = container.clientHeight || 800;
                
                this.svg = d3.select(container)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);
                
                // Create zoom behavior
                const zoom = d3.zoom()
                    .scaleExtent([0.1, 4])
                    .on('zoom', (event) => {
                        this.svg.select('.zoom-group').attr('transform', event.transform);
                    });
                
                this.svg.call(zoom);
                
                const g = this.svg.append('g').attr('class', 'zoom-group');
                
                // Filter data for better performance
                let nodes = this.networkData.nodes;
                let edges = this.networkData.edges;
                
                // If dataset is very large, sample it
                if (nodes.length > 1000) {
                    const sampleSize = Math.min(1000, nodes.length);
                    const sampledNodes = nodes.slice(0, sampleSize);
                    const nodeIds = new Set(sampledNodes.map(n => n.id));
                    const sampledEdges = edges.filter(e => nodeIds.has(e.source) && nodeIds.has(e.target));
                    
                    nodes = sampledNodes;
                    edges = sampledEdges;
                    
                    console.log(`Sampled ${nodes.length} nodes and ${edges.length} edges for performance`);
                }
                
                // Create force simulation
                this.simulation = d3.forceSimulation(nodes)
                    .force('link', d3.forceLink(edges).id(d => d.id).distance(100))
                    .force('charge', d3.forceManyBody().strength(-300))
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('collision', d3.forceCollide().radius(d => d.size + 5));
                
                // Create links
                const links = g.append('g')
                    .selectAll('line')
                    .data(edges)
                    .join('line')
                    .attr('class', 'link');
                
                // Create nodes
                const nodeElements = g.append('g')
                    .selectAll('circle')
                    .data(nodes)
                    .join('circle')
                    .attr('class', 'node')
                    .attr('r', d => d.size)
                    .attr('fill', d => d.color)
                    .call(this.createDragBehavior())
                    .on('mouseover', this.showTooltip.bind(this))
                    .on('mouseout', this.hideTooltip.bind(this));
                
                // Create labels for larger nodes only
                const labels = g.append('g')
                    .selectAll('text')
                    .data(nodes.filter(d => d.size > 20))
                    .join('text')
                    .attr('class', 'node-label')
                    .text(d => d.label.split('\\n')[0]);
                
                // Update positions on simulation tick
                this.simulation.on('tick', () => {
                    links
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);
                    
                    nodeElements
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);
                    
                    labels
                        .attr('x', d => d.x)
                        .attr('y', d => d.y + 5);
                });
                
                this.updateVisualization();
            }
            
            showError(message) {
                const container = document.getElementById('networkVisualization');
                container.innerHTML = `<div class="error-message">Error: ${message}</div>`;
            }
        }
        
        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new NetworkTopologyDashboard();
        });
        
        // Global functions
        function refreshData() {
            if (window.dashboard) {
                window.dashboard.loadNetworkStats();
                window.dashboard.loadNetworkMap();
            }
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.dashboard && window.dashboard.networkData) {
                setTimeout(() => window.dashboard.createVisualization(), 100);
            }
        });
    </script>
</body>
</html>