# AI Research Platform  – TLS terminator / reverse-proxy
#
# Served through the Tailscale certificate for:
#   ubuntuaicodeserver-1.tail5137b4.ts.net

server {
    listen 10443 ssl http2;
    server_name ubuntuaicodeserver-1.tail5137b4.ts.net;

    # --- TLS (Tailscale) ---
    ssl_certificate     /etc/ssl/tailscale/ubuntuaicodeserver-1.tail5137b4.ts.net.crt;
    ssl_certificate_key /etc/ssl/tailscale/ubuntuaicodeserver-1.tail5137b4.ts.net.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # --- Global & security snippets (keep if they exist) ---
    include /etc/nginx/sites-available/01-global-settings.conf;
    include /etc/nginx/sites-available/03-security-headers.conf;

    # Optional Basic-Auth / IP allow-list
    # if ($allow_ip = 0) { return 403; }
    # auth_basic "Protected Services";
    # auth_basic_user_file /etc/nginx/.htpasswd;

    # ─────────────────────────────────────────
    #  Service map   (path → container port)
    # ─────────────────────────────────────────
    location /vscode/          { proxy_pass http://127.0.0.1:57081/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /copilot/api/     { proxy_pass http://127.0.0.1:11000/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /copilot/         { proxy_pass http://127.0.0.1:11000/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /autogen/         { proxy_pass http://127.0.0.1:11001/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /magentic/        { proxy_pass http://127.0.0.1:11003/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /webhook/         { proxy_pass http://127.0.0.1:11025/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /perplexica/      { proxy_pass http://127.0.0.1:11020/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /searxng/         { proxy_pass http://127.0.0.1:11021/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /grafana-3/        { proxy_pass http://127.0.0.1:11002/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /grafana-2/        { proxy_pass http://127.0.0.1:11002/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /grafana/        { proxy_pass http://127.0.0.1:11002/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /prompt-forge/        { proxy_pass http://127.0.0.1:11500/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /portscanner/     { proxy_pass http://127.0.0.1:11010/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /nginx/           { proxy_pass http://127.0.0.1:8080/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /gateway-admin/   { proxy_pass http://127.0.0.1:11082/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /ollama-api/      { proxy_pass http://127.0.0.1:11434/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /windmill/        { proxy_pass http://127.0.0.1:11006/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /ntopng/          { proxy_pass http://127.0.0.1:8888/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    
    # OpenWebUI - strip the path prefix
    location /openwebui/ {
        proxy_pass http://127.0.0.1:11880/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Neo4j GenAI Stack Services
    location /neo4j/ {
        proxy_pass http://127.0.0.1:7474/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    location /genai-stack/loader/  { proxy_pass http://127.0.0.1:8502/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/import/  { proxy_pass http://127.0.0.1:8081/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/bot/     { proxy_pass http://127.0.0.1:8501/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/pdf/     { proxy_pass http://127.0.0.1:8503/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/api/     { proxy_pass http://127.0.0.1:8504/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/         { proxy_pass http://127.0.0.1:8505/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }

    # Control-Panel shortcut:  /hub  →  /control-panel.html (served by Chat-Copilot web)
    location /hub {
        rewrite ^/hub/?$ /control-panel.html break;
        proxy_pass http://127.0.0.1:11000;
        include /etc/nginx/sites-available/04-proxy-settings.conf;
    }

    # Root path – OpenWebUI
    location / {
        proxy_pass http://127.0.0.1:11880/;
        include /etc/nginx/sites-available/04-proxy-settings.conf;
    }

    # Access / error logs (optional)
    access_log /var/log/nginx/ai-hub.access.log combined;
    error_log  /var/log/nginx/ai-hub.error.log;
}

# HTTP Server Block - Port 11999 (Nginx Gateway)
server {
    listen 11999;
    server_name 100.123.10.72 localhost;

    # ─────────────────────────────────────────
    #  Service map   (path → container port)
    # ─────────────────────────────────────────
    location /vscode/          { proxy_pass http://127.0.0.1:57081/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /copilot/api/     { proxy_pass http://127.0.0.1:40443/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /copilot/         { proxy_pass http://127.0.0.1:11000/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /autogen/         { proxy_pass http://127.0.0.1:11001/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /magentic/        { proxy_pass http://127.0.0.1:11003/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /webhook/         { proxy_pass http://127.0.0.1:11025/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /perplexica/      { proxy_pass http://127.0.0.1:11020/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /searxng/         { proxy_pass http://127.0.0.1:11021/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /grafana-3/        { proxy_pass http://127.0.0.1:11002/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /grafana-2/        { proxy_pass http://127.0.0.1:11002/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /grafana/        { proxy_pass http://127.0.0.1:11002/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /prompt-forge/    { proxy_pass http://127.0.0.1:11500/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /portscanner/     { proxy_pass http://127.0.0.1:11010/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /nginx/           { proxy_pass http://127.0.0.1:8080/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /gateway-admin/   { proxy_pass http://127.0.0.1:11082/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /ollama-api/      { proxy_pass http://127.0.0.1:11434/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /windmill/        { proxy_pass http://127.0.0.1:11006/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /ntopng/          { proxy_pass http://127.0.0.1:8888/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    
    # OpenWebUI - strip the path prefix
    location /openwebui/ {
        proxy_pass http://127.0.0.1:11880/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    # n8n reverse proxy
    location /n8n/ {
        proxy_pass http://127.0.0.1:5678;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # WebSocket support for n8n
    location /socket.io/ {
        proxy_pass http://127.0.0.1:5678;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    # Neo4j GenAI Stack Services
    location /neo4j/ {
        proxy_pass http://127.0.0.1:7474/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    location /genai-stack/loader/  { proxy_pass http://127.0.0.1:8502/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/import/  { proxy_pass http://127.0.0.1:8081/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/bot/     { proxy_pass http://127.0.0.1:8501/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/pdf/     { proxy_pass http://127.0.0.1:8503/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/api/     { proxy_pass http://127.0.0.1:8504/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/         { proxy_pass http://127.0.0.1:8505/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }

    # Control-Panel and static files - served by Chat-Copilot web
    location /control-panel.html {
        proxy_pass http://127.0.0.1:11000/control-panel.html;
        include /etc/nginx/sites-available/04-proxy-settings.conf;
    }
    
    location /applications.html {
        proxy_pass http://127.0.0.1:11000/applications.html;
        include /etc/nginx/sites-available/04-proxy-settings.conf;
    }

    # Control-Panel shortcut:  /hub  →  /control-panel.html (served by Chat-Copilot web)
    location /hub {
        rewrite ^/hub/?$ /control-panel.html break;
        proxy_pass http://127.0.0.1:11000;
        include /etc/nginx/sites-available/04-proxy-settings.conf;
    }

    # Root path – serve Chat Copilot main app
    location / {
        proxy_pass http://127.0.0.1:11000/;
        include /etc/nginx/sites-available/04-proxy-settings.conf;
    }

    # Access / error logs (optional)
    access_log /var/log/nginx/ai-hub-http.access.log combined;
    error_log  /var/log/nginx/ai-hub-http.error.log;
}
