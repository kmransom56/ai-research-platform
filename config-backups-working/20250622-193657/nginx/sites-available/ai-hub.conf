# AI Research Platform  – TLS terminator / reverse-proxy
#
# Served through the Tailscale certificate for:
#   ubuntuaicodeserver-1.tail5137b4.ts.net

server {
    listen 10443 ssl http2;
    server_name ubuntuaicodeserver-1.tail5137b4.ts.net;

    # --- TLS (Tailscale) ---
    ssl_certificate     /etc/ssl/tailscale/ubuntuaicodeserver-1.tail5137b4.ts.net.crt;
    ssl_certificate_key /etc/ssl/tailscale/ubuntuaicodeserver-1.tail5137b4.ts.net.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # --- Global & security snippets (keep if they exist) ---
    include /etc/nginx/sites-available/01-global-settings.conf;
    include /etc/nginx/sites-available/03-security-headers.conf;

    # Optional Basic-Auth / IP allow-list
    # if ($allow_ip = 0) { return 403; }
    # auth_basic "Protected Services";
    # auth_basic_user_file /etc/nginx/.htpasswd;

    # ─────────────────────────────────────────
    #  Service map   (path → container port)
    # ─────────────────────────────────────────
    location /vscode/          { proxy_pass http://127.0.0.1:57081/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /copilot/api/     { proxy_pass http://127.0.0.1:11000/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /copilot/         { proxy_pass http://127.0.0.1:3000/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /autogen/         { proxy_pass http://127.0.0.1:11001/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /magentic/        { proxy_pass http://127.0.0.1:11003/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /webhook/         { proxy_pass http://127.0.0.1:11002/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /perplexica/      { proxy_pass http://127.0.0.1:11020/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /searxng/         { proxy_pass http://127.0.0.1:11021/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /portscanner/     { proxy_pass http://127.0.0.1:11010/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /nginx/           { proxy_pass http://127.0.0.1:11080/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /gateway-http/    { proxy_pass http://127.0.0.1:11081/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /gateway-https/   { proxy_pass http://127.0.0.1:11082/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /fortinet/        { proxy_pass http://127.0.0.1:3001/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /ollama-api/      { proxy_pass http://127.0.0.1:11434/;  include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /bacula/          { proxy_pass http://127.0.0.1:8081/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    
    # OpenWebUI - strip the path prefix
    location /openwebui/ {
        proxy_pass http://127.0.0.1:11880/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Neo4j GenAI Stack Services
    location /neo4j/ {
        proxy_pass http://127.0.0.1:7474/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    location /genai-stack/loader/  { proxy_pass http://127.0.0.1:8502/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/import/  { proxy_pass http://127.0.0.1:8081/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/bot/     { proxy_pass http://127.0.0.1:8501/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/pdf/     { proxy_pass http://127.0.0.1:8503/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/api/     { proxy_pass http://127.0.0.1:8504/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }
    location /genai-stack/         { proxy_pass http://127.0.0.1:8505/;   include /etc/nginx/sites-available/04-proxy-settings.conf; }

    # Control-Panel shortcut:  /hub  →  /control-panel.html (served by Chat-Copilot web)
    location /hub {
        rewrite ^/hub/?$ /control-panel.html break;
        proxy_pass http://127.0.0.1:3000;
        include /etc/nginx/sites-available/04-proxy-settings.conf;
    }

    # Root path – OpenWebUI
    location / {
        proxy_pass http://127.0.0.1:11880/;
        include /etc/nginx/sites-available/04-proxy-settings.conf;
    }

    # Access / error logs (optional)
    access_log /var/log/nginx/ai-hub.access.log combined;
    error_log  /var/log/nginx/ai-hub.error.log;
}

server {
    listen 443 ssl;
    server_name ubuntuaicodeserver-1.tail5137b4.ts.net;
    ssl_certificate     /etc/ssl/tailscale/ubuntuaicodeserver-1.tail5137b4.ts.net.crt;
    ssl_certificate_key /etc/ssl/tailscale/ubuntuaicodeserver-1.tail5137b4.ts.net.key;

    return 301 https://$host:10443$request_uri;
}