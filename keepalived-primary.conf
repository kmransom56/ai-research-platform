! Configuration File for keepalived
! HA Load Balancer - Primary Node

global_defs {
   notification_email {
     admin@chatcopilot.local
   }
   notification_email_from keepalived@primary
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id LVS_PRIMARY
   enable_script_security
}

vrrp_script chk_ai_gateway {
    script "/bin/curl -f http://localhost:9000/health || exit 1"
    interval 15
    weight -20
    fall 3
    rise 2
    timeout 5
}

vrrp_script chk_chat_copilot {
    script "/bin/curl -f http://localhost:11000/healthz || exit 1"
    interval 15
    weight -20
    fall 3
    rise 2
    timeout 5
}

vrrp_instance VI_1 {
    state MASTER
    interface eno1
    virtual_router_id 51
    priority 110
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass ha_cluster_2025
    }
    virtual_ipaddress {
        192.168.0.100/24 brd 192.168.0.255 dev eno1
    }
    track_script {
        chk_ai_gateway
        chk_chat_copilot
    }
    notify_master "/home/keith/chat-copilot/scripts/ha-management/master_notify.sh"
    notify_backup "/home/keith/chat-copilot/scripts/ha-management/backup_notify.sh"
    notify_fault "/home/keith/chat-copilot/scripts/ha-management/fault_notify.sh"
}

# PostgreSQL Virtual Service
virtual_server 192.168.0.100 5432 {
    delay_loop 15
    lb_algo rr
    lb_kind NAT
    persistence_timeout 300
    protocol TCP

    real_server 192.168.0.1 5432 {
        weight 100
        TCP_CHECK {
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
            connect_port 5432
        }
    }
    real_server 192.168.0.2 5432 {
        weight 50
        TCP_CHECK {
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
            connect_port 5432
        }
    }
}

# AI Gateway Virtual Service
virtual_server 192.168.0.100 9000 {
    delay_loop 15
    lb_algo wlc
    lb_kind NAT
    persistence_timeout 0
    protocol TCP

    real_server 192.168.0.1 9000 {
        weight 70
        HTTP_GET {
            url {
                path /health
                status_code 200
            }
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
            connect_port 9000
        }
    }
    real_server 192.168.0.2 9000 {
        weight 30
        HTTP_GET {
            url {
                path /health
                status_code 200
            }
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
            connect_port 9000
        }
    }
}

# Chat Copilot Backend Virtual Service
virtual_server 192.168.0.100 11000 {
    delay_loop 15
    lb_algo wlc
    lb_kind NAT
    persistence_timeout 300
    protocol TCP

    real_server 192.168.0.1 11000 {
        weight 70
        HTTP_GET {
            url {
                path /healthz
                status_code 200
            }
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
            connect_port 11000
        }
    }
    real_server 192.168.0.2 11000 {
        weight 30
        HTTP_GET {
            url {
                path /healthz
                status_code 200
            }
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
            connect_port 11000
        }
    }
}