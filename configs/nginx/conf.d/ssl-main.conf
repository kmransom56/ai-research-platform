# SSL Main Configuration for AI Platform
# Main server block with SSL configuration

# Include proxy settings
include /etc/nginx/conf.d/04-proxy-settings.conf;

server {
    listen 80;
    listen [::]:80;
    server_name _;
    
    # Redirect HTTP to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name _;
    
    # SSL Configuration
    ssl_certificate /etc/ssl/certs/server.crt;
    ssl_certificate_key /etc/ssl/private/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Root directory for static files
    root /var/www/html;
    index index.html index.htm;
    
    # Main application routes
    location / {
        try_files $uri $uri/ @backend;
    }
    
    # Backend proxy for API calls
    location @backend {
        proxy_pass http://host.docker.internal:11000;
    }
    
    # Chat Copilot Frontend
    location /copilot/ {
        proxy_pass http://host.docker.internal:3000/;
    }
    
    # AutoGen Studio
    location /autogen/ {
        proxy_pass http://host.docker.internal:11001/;
    }
    
    # Webhook Server
    location /webhook/ {
        proxy_pass http://host.docker.internal:11002/;
    }
    
    # Magentic-One
    location /magentic/ {
        proxy_pass http://host.docker.internal:11003/;
    }
    
    # GenAI Stack services
    location /genai-api/ {
        proxy_pass http://host.docker.internal:8504/;
    }
    
    location /genai-bot/ {
        proxy_pass http://host.docker.internal:8501/;
    }
    
    location /genai-frontend/ {
        proxy_pass http://host.docker.internal:8505/;
    }
    
    # Neo4j Browser
    location /neo4j/ {
        proxy_pass http://host.docker.internal:7474/;
    }
    
    # OpenWebUI
    location /openwebui/ {
        proxy_pass http://host.docker.internal:11880/;
    }
    
    # Perplexica
    location /perplexica/ {
        proxy_pass http://host.docker.internal:11020/;
    }
    
    # SearXNG
    location /searxng/ {
        proxy_pass http://host.docker.internal:11021/;
    }
    
    # VS Code Web
    location /vscode/ {
        proxy_pass http://host.docker.internal:57081/;
    }
    
    # Port Scanner
    location /portscanner/ {
        proxy_pass http://host.docker.internal:11010/;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
